
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bingads.v13.bulk.bulk_service_manager &#8212; Bing Ads SDK 13.0.15 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/classic.css" />
    
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Bing Ads SDK 13.0.15 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">bingads.v13.bulk.bulk_service_manager</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for bingads.v13.bulk.bulk_service_manager</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">io</span>

<span class="kn">from</span> <span class="nn">.bulk_operation</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.upload_parameters</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.file_reader</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.file_writer</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">bingads.manifest</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">bingads.service_client</span> <span class="kn">import</span> <span class="n">ServiceClient</span>
<span class="kn">from</span> <span class="nn">bingads.authorization</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">bingads.util</span> <span class="kn">import</span> <span class="n">_TimeHelper</span>
<span class="kn">from</span> <span class="nn">bingads.exceptions</span> <span class="kn">import</span> <span class="n">TimeoutException</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">PY2</span><span class="p">,</span> <span class="n">PY3</span>


<div class="viewcode-block" id="BulkServiceManager"><a class="viewcode-back" href="../../../../bingads.v13.bulk.html#bingads.v13.bulk.bulk_service_manager.BulkServiceManager">[docs]</a><span class="k">class</span> <span class="nc">BulkServiceManager</span><span class="p">:</span>
    <span class="n">SYNC_THRESHOLD</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">BOMLEN</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">BOM_UTF8</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot; Provides high level methods for uploading and downloading entities using the Bulk API functionality.</span>

<span class="sd">    Also provides methods for submitting upload or download operations.</span>

<span class="sd">    *Example:*</span>

<span class="sd">    :func:`download_file` will submit the download request to the bulk service,</span>
<span class="sd">    poll until the status is completed (or returns an error), and downloads the file locally.</span>
<span class="sd">    If instead you want to manage the low level details you would first call :func:`submit_download`,</span>
<span class="sd">    wait for the results file to be prepared using either :meth:`.BulkDownloadOperation.get_status`</span>
<span class="sd">    or :meth:`.BulkDownloadOperation.track`, and then download the file with the</span>
<span class="sd">    :meth:`.BulkOperation.download_result_file` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authorization_data</span><span class="p">,</span> <span class="n">poll_interval_in_milliseconds</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="s1">&#39;production&#39;</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">suds_options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialize a new instance of this class.</span>

<span class="sd">        :param authorization_data: Represents a user who intends to access the corresponding customer and account.</span>
<span class="sd">        :type authorization_data: AuthorizationData</span>
<span class="sd">        :param environment: (optional) Represents which API environment to use, default is `production`, you can also pass `sandbox` in</span>
<span class="sd">        :type environment: str</span>
<span class="sd">        :param poll_interval_in_milliseconds: (optional) The time interval in milliseconds between two status polling attempts.</span>
<span class="sd">                                                         The default value is 15000 milliseconds.</span>
<span class="sd">        :type poll_interval_in_milliseconds: int</span>
<span class="sd">        :param working_directory: (optional)  Directory for storing temporary files needed for some operations</span>
<span class="sd">                                    (for example :func:`upload_entities` creates a temporary upload file).</span>
<span class="sd">        :param suds_options: The suds options need to pass to suds client</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_environment</span> <span class="o">=</span> <span class="n">environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_service_client</span> <span class="o">=</span> <span class="n">ServiceClient</span><span class="p">(</span><span class="s1">&#39;BulkService&#39;</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">authorization_data</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="o">**</span><span class="n">suds_options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_authorization_data</span> <span class="o">=</span> <span class="n">authorization_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval_in_milliseconds</span> <span class="o">=</span> <span class="n">poll_interval_in_milliseconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_working_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(),</span> <span class="n">WORKING_NAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">working_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_working_directory</span> <span class="o">=</span> <span class="n">working_directory</span>
        <span class="c1"># make sure the working directory exists or create it.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_working_directory</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_working_directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_suds_options</span> <span class="o">=</span> <span class="n">suds_options</span>

<div class="viewcode-block" id="BulkServiceManager.download_file"><a class="viewcode-back" href="../../../../bingads.v13.bulk.html#bingads.v13.bulk.bulk_service_manager.BulkServiceManager.download_file">[docs]</a>    <span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">download_parameters</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Downloads the specified Bulk entities to a local file.</span>

<span class="sd">        :param download_parameters: Determines various download parameters, for example where the file should be downloaded.</span>
<span class="sd">        :type download_parameters: DownloadParameters</span>
<span class="sd">        :param progress: (optional) Tracking the percent complete progress information for the bulk operation.</span>
<span class="sd">        :type progress: BulkOperationProgressInfo -&gt; None</span>
<span class="sd">        :return: The downloaded local bulk file path.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start_timestamp</span> <span class="o">=</span> <span class="n">_TimeHelper</span><span class="o">.</span><span class="n">get_current_time_milliseconds</span><span class="p">()</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_download</span><span class="p">(</span><span class="n">download_parameters</span><span class="o">.</span><span class="n">_submit_download_parameter</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">operation</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="n">download_parameters</span><span class="o">.</span><span class="n">timeout_in_milliseconds</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">TimeoutException</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BulkDownloadException</span><span class="p">(</span><span class="s2">&quot;Bulk file download tracking status timeout.&quot;</span><span class="p">)</span>
        <span class="n">result_file_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span>
        <span class="k">if</span> <span class="n">download_parameters</span><span class="o">.</span><span class="n">result_file_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result_file_directory</span> <span class="o">=</span> <span class="n">download_parameters</span><span class="o">.</span><span class="n">result_file_directory</span>
        <span class="n">download_result_file_timeout</span> <span class="o">=</span> <span class="n">_TimeHelper</span><span class="o">.</span><span class="n">get_remaining_time_milliseconds_with_min_value</span><span class="p">(</span><span class="n">start_timestamp</span><span class="p">,</span> <span class="n">download_parameters</span><span class="o">.</span><span class="n">timeout_in_milliseconds</span><span class="p">)</span>
        <span class="n">result_file_path</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">download_result_file</span><span class="p">(</span>
            <span class="n">result_file_directory</span><span class="o">=</span><span class="n">result_file_directory</span><span class="p">,</span>
            <span class="n">result_file_name</span><span class="o">=</span><span class="n">download_parameters</span><span class="o">.</span><span class="n">result_file_name</span><span class="p">,</span>
            <span class="n">decompress</span><span class="o">=</span><span class="n">download_parameters</span><span class="o">.</span><span class="n">decompress_result_file</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="n">download_parameters</span><span class="o">.</span><span class="n">overwrite_result_file</span><span class="p">,</span>
            <span class="n">timeout_in_milliseconds</span><span class="o">=</span><span class="n">download_result_file_timeout</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result_file_path</span></div>

<div class="viewcode-block" id="BulkServiceManager.download_entities"><a class="viewcode-back" href="../../../../bingads.v13.bulk.html#bingads.v13.bulk.bulk_service_manager.BulkServiceManager.download_entities">[docs]</a>    <span class="k">def</span> <span class="nf">download_entities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">download_parameters</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Downloads the specified Bulk entities.</span>

<span class="sd">        :param download_parameters: Determines various download parameters, for example where the file should be downloaded.</span>
<span class="sd">        :type download_parameters: DownloadParameters</span>
<span class="sd">        :param progress: (optional) Tracking the percent complete progress information for the bulk operation.</span>
<span class="sd">        :type progress: BulkOperationProgressInfo -&gt; None</span>
<span class="sd">        :return: Bulk entity generator.</span>
<span class="sd">        :rtype: generator[BulkEntity]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">result_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">download_parameters</span><span class="p">,</span> <span class="n">progress</span><span class="p">)</span>
        <span class="n">result_file_type</span> <span class="o">=</span> <span class="n">ResultFileType</span><span class="o">.</span><span class="n">full_download</span> \
            <span class="k">if</span> <span class="n">download_parameters</span><span class="o">.</span><span class="n">last_sync_time_in_utc</span> <span class="ow">is</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="n">ResultFileType</span><span class="o">.</span><span class="n">partial_download</span>
        <span class="k">with</span> <span class="n">BulkFileReader</span><span class="p">(</span>
            <span class="n">file_path</span><span class="o">=</span><span class="n">result_file_path</span><span class="p">,</span>
            <span class="n">result_file_type</span><span class="o">=</span><span class="n">result_file_type</span><span class="p">,</span>
            <span class="n">file_type</span><span class="o">=</span><span class="n">download_parameters</span><span class="o">.</span><span class="n">file_type</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">entity</span></div>

<div class="viewcode-block" id="BulkServiceManager.upload_file"><a class="viewcode-back" href="../../../../bingads.v13.bulk.html#bingads.v13.bulk.bulk_service_manager.BulkServiceManager.upload_file">[docs]</a>    <span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_upload_parameters</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Uploads the specified Bulk file.</span>

<span class="sd">        :param file_upload_parameters: Determines various upload parameters.</span>
<span class="sd">        :type file_upload_parameters: FileUploadParameters</span>
<span class="sd">        :param progress: (optional) Tracking the percent complete progress information for the bulk operation.</span>
<span class="sd">        :type progress: BulkOperationProgressInfo -&gt; None</span>
<span class="sd">        :return: The download local bulk file path.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">file_upload_parameters</span><span class="o">.</span><span class="n">_submit_upload_parameters</span><span class="o">.</span><span class="n">timeout_in_milliseconds</span> <span class="o">=</span> <span class="n">file_upload_parameters</span><span class="o">.</span><span class="n">timeout_in_milliseconds</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_upload</span><span class="p">(</span><span class="n">file_upload_parameters</span><span class="o">.</span><span class="n">_submit_upload_parameters</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_upload_result</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">file_upload_parameters</span><span class="p">,</span> <span class="n">progress</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="BulkServiceManager.download_upload_result"><a class="viewcode-back" href="../../../../bingads.v13.bulk.html#bingads.v13.bulk.bulk_service_manager.BulkServiceManager.download_upload_result">[docs]</a>    <span class="k">def</span> <span class="nf">download_upload_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">file_upload_parameters</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">start_timestamp</span> <span class="o">=</span> <span class="n">_TimeHelper</span><span class="o">.</span><span class="n">get_current_time_milliseconds</span><span class="p">()</span>
        <span class="n">upload_operation_timeout</span> <span class="o">=</span> <span class="n">_TimeHelper</span><span class="o">.</span><span class="n">get_remaining_time_milliseconds_with_min_value</span><span class="p">(</span><span class="n">start_timestamp</span><span class="p">,</span> <span class="n">file_upload_parameters</span><span class="o">.</span><span class="n">timeout_in_milliseconds</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">operation</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="n">upload_operation_timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">TimeoutException</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BulkUploadException</span><span class="p">(</span><span class="s2">&quot;Bulk file upload tracking status timeout.&quot;</span><span class="p">)</span>
        <span class="n">result_file_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span>
        <span class="k">if</span> <span class="n">file_upload_parameters</span><span class="o">.</span><span class="n">result_file_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result_file_directory</span> <span class="o">=</span> <span class="n">file_upload_parameters</span><span class="o">.</span><span class="n">result_file_directory</span>
        <span class="n">download_result_file_timeout</span> <span class="o">=</span> <span class="n">_TimeHelper</span><span class="o">.</span><span class="n">get_remaining_time_milliseconds_with_min_value</span><span class="p">(</span><span class="n">start_timestamp</span><span class="p">,</span> <span class="n">file_upload_parameters</span><span class="o">.</span><span class="n">timeout_in_milliseconds</span><span class="p">)</span>
        <span class="n">result_file_path</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">download_result_file</span><span class="p">(</span>
            <span class="n">result_file_directory</span><span class="o">=</span><span class="n">result_file_directory</span><span class="p">,</span>
            <span class="n">result_file_name</span><span class="o">=</span><span class="n">file_upload_parameters</span><span class="o">.</span><span class="n">result_file_name</span><span class="p">,</span>
            <span class="n">decompress</span><span class="o">=</span><span class="n">file_upload_parameters</span><span class="o">.</span><span class="n">decompress_result_file</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="n">file_upload_parameters</span><span class="o">.</span><span class="n">overwrite_result_file</span><span class="p">,</span>
            <span class="n">timeout_in_milliseconds</span><span class="o">=</span><span class="n">download_result_file_timeout</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result_file_path</span></div>
    
<div class="viewcode-block" id="BulkServiceManager.need_to_try_upload_entity_records_sync_first"><a class="viewcode-back" href="../../../../bingads.v13.bulk.html#bingads.v13.bulk.bulk_service_manager.BulkServiceManager.need_to_try_upload_entity_records_sync_first">[docs]</a>    <span class="k">def</span> <span class="nf">need_to_try_upload_entity_records_sync_first</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_upload_parameters</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity_upload_parameters</span><span class="o">.</span><span class="n">entities</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">BulkServiceManager</span><span class="o">.</span><span class="n">SYNC_THRESHOLD</span></div>

<div class="viewcode-block" id="BulkServiceManager.bulkupload_entities"><a class="viewcode-back" href="../../../../bingads.v13.bulk.html#bingads.v13.bulk.bulk_service_manager.BulkServiceManager.bulkupload_entities">[docs]</a>    <span class="k">def</span> <span class="nf">bulkupload_entities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_upload_parameters</span><span class="p">,</span> <span class="n">tmp_file</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Uploads the specified Bulk entities in async way.</span>

<span class="sd">        :param entity_upload_parameters: Determines various upload parameters, for example what entities to upload.</span>
<span class="sd">        :type entity_upload_parameters: EntityUploadParameters</span>
<span class="sd">        :param tmp_file: The temp file path that contains the content to upload</span>
<span class="sd">        :type tmp_file: string </span>
<span class="sd">        :param progress: (optional) Tracking the percent complete progress information for the bulk operation.</span>
<span class="sd">        :type progress: BulkOperationProgressInfo -&gt; None</span>
<span class="sd">        :return: Bulk entity generator.</span>
<span class="sd">        :rtype: generator[BulkEntity]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">file_upload_parameters</span> <span class="o">=</span> <span class="n">FileUploadParameters</span><span class="p">(</span>
            <span class="n">upload_file_path</span><span class="o">=</span><span class="n">tmp_file</span><span class="p">,</span>
            <span class="n">result_file_directory</span><span class="o">=</span><span class="n">entity_upload_parameters</span><span class="o">.</span><span class="n">result_file_directory</span><span class="p">,</span>
            <span class="n">result_file_name</span><span class="o">=</span><span class="n">entity_upload_parameters</span><span class="o">.</span><span class="n">result_file_name</span><span class="p">,</span>
            <span class="n">overwrite_result_file</span><span class="o">=</span><span class="n">entity_upload_parameters</span><span class="o">.</span><span class="n">overwrite_result_file</span><span class="p">,</span>
            <span class="n">response_mode</span><span class="o">=</span><span class="n">entity_upload_parameters</span><span class="o">.</span><span class="n">response_mode</span><span class="p">,</span>
            <span class="n">compress_upload_file</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span>
            <span class="n">file_upload_parameters</span><span class="o">=</span><span class="n">file_upload_parameters</span><span class="p">,</span>
            <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">BulkFileReader</span><span class="p">(</span><span class="n">result_file_path</span><span class="p">,</span> <span class="n">result_file_type</span><span class="o">=</span><span class="n">ResultFileType</span><span class="o">.</span><span class="n">upload</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">entity</span></div>
    
<div class="viewcode-block" id="BulkServiceManager.bulkupload_entitie_records"><a class="viewcode-back" href="../../../../bingads.v13.bulk.html#bingads.v13.bulk.bulk_service_manager.BulkServiceManager.bulkupload_entitie_records">[docs]</a>    <span class="k">def</span> <span class="nf">bulkupload_entitie_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_upload_parameters</span><span class="p">,</span> <span class="n">tmp_file</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Uploads the specified Bulk entities in sync way by UploadEntityRecords.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_client</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;ns2:ArrayOfstring&quot;</span><span class="p">)</span>
        <span class="n">tmp_csv_file</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8-sig&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
            <span class="n">records</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmp_csv_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
        <span class="k">elif</span> <span class="n">PY2</span><span class="p">:</span>
            <span class="n">records</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tmp_csv_file</span><span class="p">]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#print(self.service_client)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_client</span><span class="o">.</span><span class="n">UploadEntityRecords</span><span class="p">(</span>
                <span class="n">AccountId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_authorization_data</span><span class="o">.</span><span class="n">account_id</span><span class="p">,</span>
                <span class="n">EntityRecords</span><span class="o">=</span><span class="n">records</span><span class="p">,</span>
                <span class="n">ResponseMode</span><span class="o">=</span><span class="n">entity_upload_parameters</span><span class="o">.</span><span class="n">response_mode</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">need_to_fall_back_to_async</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_client</span><span class="o">.</span><span class="n">get_response_header</span><span class="p">()</span>
                <span class="n">operation</span> <span class="o">=</span> <span class="n">BulkUploadOperation</span><span class="p">(</span>
                    <span class="n">request_id</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">RequestId</span><span class="p">,</span>
                    <span class="n">authorization_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_authorization_data</span><span class="p">,</span>
                    <span class="n">poll_interval_in_milliseconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval_in_milliseconds</span><span class="p">,</span>
                    <span class="n">environment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_environment</span><span class="p">,</span>
                    <span class="n">tracking_id</span><span class="o">=</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;TrackingId&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;TrackingId&#39;</span> <span class="ow">in</span> <span class="n">headers</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">suds_options</span>
                    <span class="p">)</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_upload_result</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">entity_upload_parameters</span><span class="p">,</span> <span class="n">progress</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_result_from_bulk_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_bulkupsert_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> 
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;OperationNotSupported&#39;</span> <span class="o">==</span> <span class="n">operation_errorcode_of_exception</span><span class="p">(</span><span class="n">ex</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulkupload_entities</span><span class="p">(</span><span class="n">entity_upload_parameters</span><span class="p">,</span> <span class="n">tmp_file</span><span class="p">,</span> <span class="n">progress</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ex</span></div>
            
<div class="viewcode-block" id="BulkServiceManager.need_to_fall_back_to_async"><a class="viewcode-back" href="../../../../bingads.v13.bulk.html#bingads.v13.bulk.bulk_service_manager.BulkServiceManager.need_to_fall_back_to_async">[docs]</a>    <span class="k">def</span> <span class="nf">need_to_fall_back_to_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">RequestId</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
            <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">RequestId</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> \
            <span class="n">response</span><span class="o">.</span><span class="n">RequestStatus</span> <span class="o">==</span> <span class="s1">&#39;InProgress&#39;</span></div>
            
<div class="viewcode-block" id="BulkServiceManager.read_result_from_bulk_file"><a class="viewcode-back" href="../../../../bingads.v13.bulk.html#bingads.v13.bulk.bulk_service_manager.BulkServiceManager.read_result_from_bulk_file">[docs]</a>    <span class="k">def</span> <span class="nf">read_result_from_bulk_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_bulk_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">BulkFileReader</span><span class="p">(</span><span class="n">result_bulk_file</span><span class="p">,</span> <span class="n">result_file_type</span><span class="o">=</span><span class="n">ResultFileType</span><span class="o">.</span><span class="n">upload</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">entity</span></div>
            
<div class="viewcode-block" id="BulkServiceManager.read_bulkupsert_response"><a class="viewcode-back" href="../../../../bingads.v13.bulk.html#bingads.v13.bulk.bulk_service_manager.BulkServiceManager.read_bulkupsert_response">[docs]</a>    <span class="k">def</span> <span class="nf">read_bulkupsert_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>        
        <span class="k">with</span> <span class="n">BulkRowsReader</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">EntityRecords</span><span class="o">.</span><span class="n">string</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">entity</span></div>
    
<div class="viewcode-block" id="BulkServiceManager.retry_with_BulkUpload"><a class="viewcode-back" href="../../../../bingads.v13.bulk.html#bingads.v13.bulk.bulk_service_manager.BulkServiceManager.retry_with_BulkUpload">[docs]</a>    <span class="k">def</span> <span class="nf">retry_with_BulkUpload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bulkupsert_response</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">bulkupsert_response</span><span class="o">.</span><span class="n">Errors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">ErrorCode</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">bulkupsert_response</span><span class="o">.</span><span class="n">Errors</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">FailedBulkUpsertRetryBulkUploadInstead</span> <span class="ow">in</span> <span class="n">error_codes</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="BulkServiceManager.upload_entities"><a class="viewcode-back" href="../../../../bingads.v13.bulk.html#bingads.v13.bulk.bulk_service_manager.BulkServiceManager.upload_entities">[docs]</a>    <span class="k">def</span> <span class="nf">upload_entities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_upload_parameters</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Uploads the specified Bulk entities.</span>

<span class="sd">        :param entity_upload_parameters: Determines various upload parameters, for example what entities to upload.</span>
<span class="sd">        :type entity_upload_parameters: EntityUploadParameters</span>
<span class="sd">        :param progress: (optional) Tracking the percent complete progress information for the bulk operation.</span>
<span class="sd">        :type progress: BulkOperationProgressInfo -&gt; None</span>
<span class="sd">        :return: Bulk entity generator.</span>
<span class="sd">        :rtype: generator[BulkEntity]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">tmp_file</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">()))</span>
        <span class="k">with</span> <span class="n">BulkFileWriter</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entity_upload_parameters</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">write_entity</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">need_to_try_upload_entity_records_sync_first</span><span class="p">(</span><span class="n">entity_upload_parameters</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulkupload_entitie_records</span><span class="p">(</span><span class="n">entity_upload_parameters</span><span class="p">,</span> <span class="n">tmp_file</span><span class="p">,</span> <span class="n">progress</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulkupload_entities</span><span class="p">(</span><span class="n">entity_upload_parameters</span><span class="p">,</span> <span class="n">tmp_file</span><span class="p">,</span> <span class="n">progress</span><span class="p">)</span></div>

<div class="viewcode-block" id="BulkServiceManager.submit_download"><a class="viewcode-back" href="../../../../bingads.v13.bulk.html#bingads.v13.bulk.bulk_service_manager.BulkServiceManager.submit_download">[docs]</a>    <span class="k">def</span> <span class="nf">submit_download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submit_download_parameters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Submits a download request to the Bing Ads bulk service with the specified parameters.</span>

<span class="sd">        :param submit_download_parameters: Determines various download parameters, for example what entities to download.</span>
<span class="sd">        :type submit_download_parameters: SubmitDownloadParameters</span>
<span class="sd">        :return: The submitted download operation</span>
<span class="sd">        :rtype: BulkDownloadOperation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data_scope</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">submit_download_parameters</span><span class="o">.</span><span class="n">data_scope</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">submit_download_parameters</span><span class="o">.</span><span class="n">data_scope</span><span class="p">)</span>
        <span class="n">download_file_type</span> <span class="o">=</span> <span class="n">submit_download_parameters</span><span class="o">.</span><span class="n">file_type</span>
        <span class="n">download_entities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_client</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;ArrayOfDownloadEntity&#39;</span><span class="p">)</span>
        <span class="n">download_entities</span><span class="o">.</span><span class="n">DownloadEntity</span> <span class="o">=</span> <span class="n">submit_download_parameters</span><span class="o">.</span><span class="n">download_entities</span>

        <span class="c1"># entities = None if submit_download_parameters.entities is None else &#39; &#39;.join(</span>
        <span class="c1">#    submit_download_parameters.entities)</span>

        <span class="n">format_version</span> <span class="o">=</span> <span class="n">BULK_FORMAT_VERSION_6</span>
        <span class="n">last_sync_time_in_utc</span> <span class="o">=</span> <span class="n">submit_download_parameters</span><span class="o">.</span><span class="n">last_sync_time_in_utc</span>

        <span class="k">if</span> <span class="n">submit_download_parameters</span><span class="o">.</span><span class="n">campaign_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_client</span><span class="o">.</span><span class="n">DownloadCampaignsByAccountIds</span><span class="p">(</span>
                <span class="n">AccountIds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_authorization_data</span><span class="o">.</span><span class="n">account_id</span><span class="p">]},</span>
                <span class="n">DataScope</span><span class="o">=</span><span class="n">data_scope</span><span class="p">,</span>
                <span class="n">DownloadFileType</span><span class="o">=</span><span class="n">download_file_type</span><span class="p">,</span>
                <span class="n">DownloadEntities</span><span class="o">=</span><span class="n">download_entities</span><span class="p">,</span>
                <span class="n">FormatVersion</span><span class="o">=</span><span class="n">format_version</span><span class="p">,</span>
                <span class="n">LastSyncTimeInUTC</span><span class="o">=</span><span class="n">last_sync_time_in_utc</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_client</span><span class="o">.</span><span class="n">get_response_header</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_client</span><span class="o">.</span><span class="n">DownloadCampaignsByCampaignIds</span><span class="p">(</span>
                <span class="n">Campaigns</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;CampaignScope&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span><span class="s1">&#39;CampaignId&#39;</span><span class="p">:</span> <span class="n">campaign_id</span><span class="p">,</span> <span class="s1">&#39;ParentAccountId&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authorization_data</span><span class="o">.</span><span class="n">account_id</span><span class="p">}</span>
                        <span class="k">for</span> <span class="n">campaign_id</span> <span class="ow">in</span> <span class="n">submit_download_parameters</span><span class="o">.</span><span class="n">campaign_ids</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="n">DataScope</span><span class="o">=</span><span class="n">data_scope</span><span class="p">,</span>
                <span class="n">DownloadFileType</span><span class="o">=</span><span class="n">download_file_type</span><span class="p">,</span>
                <span class="n">DownloadEntities</span><span class="o">=</span><span class="n">download_entities</span><span class="p">,</span>
                <span class="n">FormatVersion</span><span class="o">=</span><span class="n">format_version</span><span class="p">,</span>
                <span class="n">LastSyncTimeInUTC</span><span class="o">=</span><span class="n">last_sync_time_in_utc</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_client</span><span class="o">.</span><span class="n">get_response_header</span><span class="p">()</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">BulkDownloadOperation</span><span class="p">(</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
            <span class="n">authorization_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_authorization_data</span><span class="p">,</span>
            <span class="n">poll_interval_in_milliseconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval_in_milliseconds</span><span class="p">,</span>
            <span class="n">environment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_environment</span><span class="p">,</span>
            <span class="n">tracking_id</span><span class="o">=</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;TrackingId&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;TrackingId&#39;</span> <span class="ow">in</span> <span class="n">headers</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">suds_options</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">operation</span></div>

<div class="viewcode-block" id="BulkServiceManager.submit_upload"><a class="viewcode-back" href="../../../../bingads.v13.bulk.html#bingads.v13.bulk.bulk_service_manager.BulkServiceManager.submit_upload">[docs]</a>    <span class="k">def</span> <span class="nf">submit_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submit_upload_parameters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Submits a request for a URL where a bulk upload file may be posted.</span>

<span class="sd">        :param submit_upload_parameters:</span>
<span class="sd">        :type submit_upload_parameters: SubmitUploadParameters</span>
<span class="sd">        :return: The submitted upload operation.</span>
<span class="sd">        :rtype: BulkUploadOperation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_client</span><span class="o">.</span><span class="n">GetBulkUploadUrl</span><span class="p">(</span>
            <span class="n">AccountId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_authorization_data</span><span class="o">.</span><span class="n">account_id</span><span class="p">,</span>
            <span class="n">ResponseMode</span><span class="o">=</span><span class="n">submit_upload_parameters</span><span class="o">.</span><span class="n">response_mode</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_client</span><span class="o">.</span><span class="n">get_response_header</span><span class="p">()</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">RequestId</span>
        <span class="n">upload_url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">UploadUrl</span>

        <span class="k">if</span>  <span class="n">submit_upload_parameters</span><span class="o">.</span><span class="n">rename_upload_file_to_match_request_id</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">os</span>
            <span class="nb">dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">submit_upload_parameters</span><span class="o">.</span><span class="n">upload_file_path</span><span class="p">)</span>
            <span class="n">new_file_to_upload</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="s1">&#39;upload_&#39;</span> <span class="o">+</span> <span class="n">request_id</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">submit_upload_parameters</span><span class="o">.</span><span class="n">upload_file_path</span><span class="p">,</span> <span class="n">new_file_to_upload</span><span class="p">)</span>
            <span class="n">submit_upload_parameters</span><span class="o">.</span><span class="n">upload_file_path</span> <span class="o">=</span> <span class="n">new_file_to_upload</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_upload_file_by_url</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">upload_url</span><span class="p">,</span>
            <span class="n">upload_file_path</span><span class="o">=</span><span class="n">submit_upload_parameters</span><span class="o">.</span><span class="n">upload_file_path</span><span class="p">,</span>
            <span class="n">compress_upload_file</span><span class="o">=</span><span class="n">submit_upload_parameters</span><span class="o">.</span><span class="n">compress_upload_file</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">BulkUploadOperation</span><span class="p">(</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
            <span class="n">authorization_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_authorization_data</span><span class="p">,</span>
            <span class="n">poll_interval_in_milliseconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval_in_milliseconds</span><span class="p">,</span>
            <span class="n">environment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_environment</span><span class="p">,</span>
            <span class="n">tracking_id</span><span class="o">=</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;TrackingId&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;TrackingId&#39;</span> <span class="ow">in</span> <span class="n">headers</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">suds_options</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">operation</span></div>

    <span class="k">def</span> <span class="nf">_upload_file_by_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">upload_file_path</span><span class="p">,</span> <span class="n">compress_upload_file</span><span class="p">,</span> <span class="n">timeout_in_milliseconds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Upload bulk file specified in upload parameters to specified URL</span>

<span class="sd">        :param url: The upload target URL.</span>
<span class="sd">        :type url: str</span>
<span class="sd">        :param upload_file_path: The fully qualified local path of the upload file.</span>
<span class="sd">        :type upload_file_path: str</span>
<span class="sd">        :param compress_upload_file: whether the upload file should be compressed before uploading.</span>
<span class="sd">        :type compress_upload_file: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">upload_file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compress_upload_file</span> <span class="ow">and</span> <span class="n">ext</span> <span class="o">!=</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
            <span class="n">should_compress</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">should_compress</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">should_compress</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">upload_file_path</span><span class="p">)</span>
                <span class="n">zip_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">.zip&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">()))</span>

                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">upload_file_path</span><span class="p">)</span>
                <span class="n">upload_file_path</span> <span class="o">=</span> <span class="n">zip_file_path</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;DeveloperToken&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authorization_data</span><span class="o">.</span><span class="n">developer_token</span><span class="p">,</span>
                <span class="s1">&#39;CustomerId&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_authorization_data</span><span class="o">.</span><span class="n">customer_id</span><span class="p">),</span>
                <span class="s1">&#39;AccountId&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_authorization_data</span><span class="o">.</span><span class="n">account_id</span><span class="p">),</span>
                <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="n">USER_AGENT</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_authorization_data</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">enrich_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">upload_file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">upload_file_path</span><span class="p">)</span>

                <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">(),</span> <span class="n">ext</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
                <span class="n">s</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;https://&#39;</span><span class="p">,</span> <span class="n">TlsHttpAdapter</span><span class="p">())</span>
                <span class="n">timeout_seconds</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">timeout_in_milliseconds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">timeout_in_milliseconds</span> <span class="o">/</span> <span class="mf">1000.0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">f</span><span class="p">)},</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FileUploadException</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ex</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">should_compress</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">upload_file_path</span><span class="p">)</span>
                <span class="n">zip_file_path</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.zip&#39;</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">service_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The internal bulk service client.</span>

<span class="sd">        :rtype: ServiceClient</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service_client</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">poll_interval_in_milliseconds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The time interval in milliseconds between two status polling attempts.</span>

<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval_in_milliseconds</span>

    <span class="nd">@poll_interval_in_milliseconds</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">poll_interval_in_milliseconds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poll_interval</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval_in_milliseconds</span> <span class="o">=</span> <span class="n">poll_interval</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">working_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Directory for storing temporary files needed for some operations (for example :func:`upload_entities` creates a temporary upload file).</span>

<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_working_directory</span>

    <span class="nd">@working_directory</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">working_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_working_directory</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">suds_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; suds option parameters</span>

<span class="sd">        :return: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_suds_options</span>

    <span class="nd">@suds_options</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">suds_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_suds_options</span> <span class="o">=</span> <span class="n">value</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Bing Ads SDK 13.0.15 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">bingads.v13.bulk.bulk_service_manager</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Bing Ads SDK Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0.
    </div>
  </body>
</html>